<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snake — Dédicace à Nolann</title>
<style>
:root{--bg:#071022;--panel:#0f1724;--accent:#30e0a1;--muted:#9aa6b2}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#041123 0%,#06142a 100%);color:#e6eef6}
.app{max-width:1100px;margin:14px auto;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:16px}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center}
h1{margin:0;font-size:18px;color:var(--accent)}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:12px}
.canvas-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;background:rgba(255,255,255,0.02);border-radius:12px}
#game{background:#01040a;border-radius:12px;width:100%;max-width:640px;height:auto;touch-action:none}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:10px 12px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;color:var(--muted);border:1px dashed rgba(255,255,255,0.03)}
.small{font-size:13px;color:var(--muted)}
.right-col{display:flex;flex-direction:column;gap:12px}
.section{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
.label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.input-row{display:flex;gap:8px;align-items:center}
.color-sample{width:28px;height:28px;border-radius:6px;border:1px solid rgba(0,0,0,0.2)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.6);padding:10px 16px;border-radius:10px;color:#dfffe9;box-shadow:0 6px 18px rgba(0,0,0,0.6);z-index:9999}
.controls-mobile{display:none}
.direction-pad{display:none}
@media(max-width:980px){.app{grid-template-columns:1fr;padding:10px}.panel{order:2}.direction-pad{display:flex;gap:6px;justify-content:center;margin-top:8px}.controls-mobile{display:flex;gap:8px;justify-content:center}.right-col{order:1}}
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Snake — Dédicace à <em>Nolann</em></h1>
      <div class="small">Touches ← ↑ → ↓ / glisser sur mobile • Esc pause</div>
    </div>

    <aside class="panel">
      <div class="section">
        <strong>Personnalisation</strong>
        <div style="margin-top:8px">
          <label class="label">Couleur du serpent</label>
          <div class="input-row"><input id="snakeColor" type="color" value="#30e0a1"><div id="snakeSample" class="color-sample"></div></div>
        </div>
        <div style="margin-top:8px">
          <label class="label">Couleur de la nourriture</label>
          <div class="input-row"><input id="foodColor" type="color" value="#ff6b6b"><div id="foodSample" class="color-sample"></div></div>
        </div>
        <div style="margin-top:8px">
          <label class="label">Fond</label>
          <div class="input-row"><input id="bgColor" type="color" value="#01040a"><div id="bgSample" class="color-sample"></div></div>
        </div>
        <div style="margin-top:8px">
          <label class="label">Vitesse initiale</label>
          <input id="speedRange" type="range" min="80" max="300" step="10" value="160">
        </div>
        <div style="margin-top:8px">
          <label><input id="enableTurbo" type="checkbox" checked> Activer le mode Turbo (préviens avant)</label>
        </div>
        <div style="margin-top:6px">
          <label><input id="disableAfter30" type="checkbox"> Désactiver turbo automatiquement à partir de 30 pts</label>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="apply">Appliquer</button>
          <button id="openMenu" class="btn-ghost">Fermer le menu</button>
        </div>
      </div>

      <div class="section" style="margin-top:10px">
        <strong>High scores</strong>
        <div id="hsList" class="small" style="margin-top:6px;max-height:160px;overflow:auto"></div>
        <div style="margin-top:8px;display:flex;gap:8px"><button id="clearHS" class="btn-ghost">Effacer</button><button id="exportHS" class="btn-ghost">Exporter JSON</button></div>
      </div>

      <div class="section" style="margin-top:10px">
        <strong>Envoyer le score</strong>
        <div class="small" style="margin-top:6px">Envoie ton score par SMS (ouvre l'app SMS si disponible)</div>
        <div style="margin-top:8px;display:flex;gap:8px"><button id="smsBtn">Envoyer par SMS</button><button id="copyBtn" class="btn-ghost">Copier</button></div>
      </div>
    </aside>

    <main class="canvas-wrap">
      <canvas id="game" width="480" height="480" aria-label="Zone de jeu"></canvas>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;width:100%">
        <div class="controls"><button id="startBtn">Démarrer</button><button id="restartBtn">Recommencer</button><button id="pauseBtn">Pause</button><button id="dedicBtn">Recommander (Nolann)</button></div>
        <div style="min-width:160px;text-align:center" class="small">Score: <strong id="score">0</strong> • Best: <strong id="best">0</strong></div>
      </div>

      <div class="controls-mobile">
        <div id="toastArea"></div>
      </div>

      <div class="direction-pad" aria-hidden="false">
        <button class="dir" data-dir="UP">↑</button>
        <div style="display:flex;gap:6px">
          <button class="dir" data-dir="LEFT">←</button>
          <button class="dir" data-dir="DOWN">↓</button>
          <button class="dir" data-dir="RIGHT">→</button>
        </div>
      </div>
    </main>

  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const dedicBtn = document.getElementById('dedicBtn');
  const smsBtn = document.getElementById('smsBtn');
  const copyBtn = document.getElementById('copyBtn');
  const applyBtn = document.getElementById('apply');
  const openMenu = document.getElementById('openMenu');
  const hsList = document.getElementById('hsList');
  const clearHS = document.getElementById('clearHS');
  const exportHS = document.getElementById('exportHS');
  const snakeColorInput = document.getElementById('snakeColor');
  const foodColorInput = document.getElementById('foodColor');
  const bgColorInput = document.getElementById('bgColor');
  const snakeSample = document.getElementById('snakeSample');
  const foodSample = document.getElementById('foodSample');
  const bgSample = document.getElementById('bgSample');
  const speedRange = document.getElementById('speedRange');
  const enableTurbo = document.getElementById('enableTurbo');
  const disableAfter30 = document.getElementById('disableAfter30');
  const toast = document.getElementById('toast');

  const GRID = 24; // logical grid
  let CELL = Math.floor(canvas.width / GRID);
  let snake = [];
  let dir = {x:0,y:0};
  let nextDir = null;
  let food = null;
  let score = 0;
  let best = parseInt(localStorage.getItem('snake_best')||'0',10);
  let hsKey = 'snake_hs_v2';
  let hs = JSON.parse(localStorage.getItem(hsKey)||'[]');
  let running = false;
  let paused = false;
  let speed = parseInt(speedRange.value,10); // ms per move
  let tickTimer = null;
  let turboActive = false;
  let turboIncoming = false;
  let turboTimeout = null;
  let turboWarnTimeout = null;
  let congratIndex = 0;

  const congrats = [
    "Bien joué ! Continue !",
    "Ça déchire !",
    "Encore un peu !",
    "Nolann serait fier !",
    "Super reflexe !",
    "Impressionnant !",
    "T'as la main !",
    "Quelle QS !",
    "Tu gères !",
    "Continue comme ça !",
    "Bravo champion !",
    "Coup parfait !",
    "Ça monte !",
    "Top combo !",
    "On voit l'expérience !",
    "Enorme !",
    "C'est propre !",
    "Belle trajectoire !",
    "Tu l'as eu !",
    "Encore un point !",
    "Super timing !",
    "Aucun stress !",
    "Flow total !",
    "Presque pro !",
    "Félicitations !",
    "Génial !",
    "Magie du joystick !",
    "Pocket pro !",
    "N'oublie pas Nolann !",
    "Continue à briller !"
  ];

  function setSamples(){ snakeSample.style.background=snakeColorInput.value; foodSample.style.background=foodColorInput.value; bgSample.style.background=bgColorInput.value; }
  setSamples();
  snakeColorInput.addEventListener('input', setSamples);
  foodColorInput.addEventListener('input', setSamples);
  bgColorInput.addEventListener('input', setSamples);

  function resizeCanvas(){
    const max = Math.min(window.innerWidth*0.9, 640);
    canvas.width = canvas.height = Math.floor(max);
    CELL = Math.floor(canvas.width / GRID);
    draw();
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function rndCell(){ return {x: Math.floor(Math.random()*GRID), y: Math.floor(Math.random()*GRID)} }

  function spawnFood(){
    let p; do{ p = rndCell(); } while(snake.some(s=>s.x===p.x && s.y===p.y));
    food = p;
  }

  function init(){
    snake = [{x:Math.floor(GRID/2), y:Math.floor(GRID/2)}];
    dir = {x:0,y:0};
    nextDir = null;
    spawnFood();
    score = 0;
    running = false;
    paused = false;
    turboActive = false;
    turboIncoming = false;
    clearTimers();
    updateUI();
    draw();
  }

  function clearTimers(){ if(tickTimer) clearInterval(tickTimer); tickTimer = null; if(turboTimeout){ clearTimeout(turboTimeout); turboTimeout=null; } if(turboWarnTimeout){ clearTimeout(turboWarnTimeout); turboWarnTimeout=null; } }

  function start(){ if(running) return; running=true; paused=false; speed = parseInt(speedRange.value,10); tickTimer = setInterval(tick, speed); showToast('Go !'); }

  function restart(){ clearTimers(); init(); start(); }

  function pauseToggle(){ if(!running) return; paused = !paused; if(paused){ clearInterval(tickTimer); tickTimer = null; pauseBtn.textContent = 'Reprendre'; showToast('Pause'); } else { tickTimer = setInterval(tick, speed); pauseBtn.textContent = 'Pause'; showToast('Reprise'); } }

  function endGame(){ running=false; clearTimers(); saveHighScore(); if(score>best){ best=score; localStorage.setItem('snake_best', best); } showToast('Game over — score: '+score); updateUI(); }

  function saveHighScore(){ hs.push({score:score, date:new Date().toLocaleString()}); hs.sort((a,b)=>b.score-a.score); if(hs.length>10) hs.length=10; localStorage.setItem(hsKey, JSON.stringify(hs)); renderHS(); }

  function renderHS(){ hs = JSON.parse(localStorage.getItem(hsKey)||'[]'); hsList.innerHTML = hs.length? hs.map(h=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">${h.score} pts — <span class="small">${h.date}</span></div>`).join('') : '<div class="small">Aucun high score</div>'; }
  renderHS();

  function updateUI(){ scoreEl.textContent = score; bestEl.textContent = best; }

  function showToast(msg,timeout=1800){ toast.textContent = msg; toast.style.display='block'; clearTimeout(toast._t); toast._t = setTimeout(()=>{ toast.style.display='none'; }, timeout); }

  function tick(){ if(paused) return; // move
    if(nextDir){ // apply queued direction
      if((nextDir.x !== -dir.x || nextDir.y !== -dir.y) || (dir.x===0&&dir.y===0)) dir = nextDir; nextDir = null;
    }
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
    // walls lethal
    if(head.x < 0 || head.y < 0 || head.x >= GRID || head.y >= GRID){ endGame(); return; }
    // self-collision
    if(snake.some(s=>s.x===head.x && s.y===head.y)){ endGame(); return; }
    snake.unshift(head);
    if(head.x === food.x && head.y === food.y){ score += 1; spawnFood(); maybeShowCongrats(); maybeSpeedUp(); scheduleTurboIfNeeded(); updateUI(); } else { snake.pop(); }
    draw();
  }

  function maybeShowCongrats(){ const msg = congrats[congratIndex % congrats.length]; congratIndex++; showToast(msg,1200); }

  function maybeSpeedUp(){ // optional: gradual speed up every 5 points
    if(score>0 && score%5===0){ speed = Math.max(60, speed-10); if(tickTimer){ clearInterval(tickTimer); tickTimer = setInterval(tick, speed); } showToast('Vitesse augmentée'); }
  }

  function scheduleTurboIfNeeded(){ if(!enableTurbo.checked) return; if(disableAfter30.checked && score >= 30) return; if(turboActive || turboIncoming) return; // schedule random turbo occasionally
    if(Math.random() < 0.18){ turboIncoming = true; // warn 2 seconds before
      turboWarnTimeout = setTimeout(()=>{ showToast('Turbo incoming in 3'); setTimeout(()=>{ showToast('Turbo incoming in 2'); setTimeout(()=>{ showToast('Turbo incoming in 1'); turboIncoming=false; activateTurbo(); },700); },700); }, 400);
    }
  }

  function activateTurbo(){ if(!enableTurbo.checked) return; turboActive = true; const originalSpeed = speed; speed = Math.max(40, Math.floor(speed/2)); if(tickTimer){ clearInterval(tickTimer); tickTimer = setInterval(tick, speed); }
    showToast('Turbo activé !',2000);
    turboTimeout = setTimeout(()=>{ turboActive=false; speed = parseInt(speedRange.value,10); if(tickTimer){ clearInterval(tickTimer); tickTimer = setInterval(tick, speed); } showToast('Turbo terminé'); }, 4000);
  }

  function draw(){ // improved graphics
    // background
    ctx.fillStyle = bgColorInput.value; ctx.fillRect(0,0,canvas.width,canvas.height);
    // grid subtle
    ctx.strokeStyle = 'rgba(255,255,255,0.02)'; ctx.lineWidth = 1; for(let i=0;i<=GRID;i++){ const p = i*CELL; ctx.beginPath(); ctx.moveTo(p,0); ctx.lineTo(p,canvas.height); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,p); ctx.lineTo(canvas.width,p); ctx.stroke(); }
    // food
    const fx = food.x*CELL + CELL*0.1; const fy = food.y*CELL + CELL*0.1; const fsz = CELL*0.8;
    ctx.save(); ctx.shadowColor = foodColorInput.value; ctx.shadowBlur = 12; ctx.fillStyle = foodColorInput.value; roundRect(ctx,fx,fy,fsz,fsz,Math.max(4,fsz*0.15),true,false); ctx.restore();
    // snake with gradient and head highlight
    for(let i=snake.length-1;i>=0;i--){ const s = snake[i]; const x = s.x*CELL; const y = s.y*CELL; const t = i/snake.length; ctx.save(); const grad = ctx.createLinearGradient(x,y,x+CELL,y+CELL); grad.addColorStop(0, shadeColor(snakeColorInput.value, -10*t)); grad.addColorStop(1, shadeColor(snakeColorInput.value, 10*(1-t))); ctx.fillStyle = grad; ctx.shadowColor = snakeColorInput.value; ctx.shadowBlur = i===0?18:6; roundRect(ctx,x+CELL*0.08,y+CELL*0.08,CELL*0.84,CELL*0.84, Math.max(4,CELL*0.15), true, false); ctx.restore(); }
    // HUD small
    ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.fillRect(8,8,180,30); ctx.fillStyle = '#dfeefe'; ctx.font='14px monospace'; ctx.fillText('Score: '+score,14,28);
  }

  function roundRect(ctx,x,y,w,h,r,fill,stroke){ if(typeof r==='undefined') r=6; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }

  function shadeColor(hex, percent){ // lighten/darken
    const f=parseInt(hex.slice(1),16),t=percent<0?0:255,p=Math.abs(percent)/100;const R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;const r=Math.round((t-R)*p)+R,g=Math.round((t-G)*p)+G,b=Math.round((t-B)*p)+B;return `rgb(${r},${g},${b})` }

  // controls
  window.addEventListener('keydown', e=>{
    const keys = ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Space','Escape'];
    if(keys.includes(e.key)) e.preventDefault(); // prevent page scroll
    if(e.key==='ArrowLeft' && dir.x!==1) nextDir = {x:-1,y:0};
    if(e.key==='ArrowRight' && dir.x!==-1) nextDir = {x:1,y:0};
    if(e.key==='ArrowUp' && dir.y!==1) nextDir = {x:0,y:-1};
    if(e.key==='ArrowDown' && dir.y!==-1) nextDir = {x:0,y:1};
    if(e.key==='Escape') pauseToggle();
    if(e.key===' '){ if(!running) start(); else restart(); }
  }, {passive:false});

  // touch swipe
  let touchStart = null;
  canvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; touchStart = {x:t.clientX, y:t.clientY}; }, {passive:true});
  canvas.addEventListener('touchmove', e=>{ if(!touchStart) return; const t=e.touches[0]; const dx = t.clientX - touchStart.x; const dy = t.clientY - touchStart.y; if(Math.abs(dx)>30 || Math.abs(dy)>30){ if(Math.abs(dx)>Math.abs(dy)){ if(dx>0 && dir.x!==-1) nextDir={x:1,y:0}; else if(dx<0 && dir.x!==1) nextDir={x:-1,y:0}; } else { if(dy>0 && dir.y!==-1) nextDir={x:0,y:1}; else if(dy<0 && dir.y!==1) nextDir={x:0,y:-1}; } touchStart=null; } }, {passive:true});

  // on-screen directional buttons
  document.querySelectorAll('.dir').forEach(b=>b.addEventListener('click', ()=>{ const d=b.dataset.dir; if(d==='LEFT'&&dir.x!==1) nextDir={x:-1,y:0}; if(d==='RIGHT'&&dir.x!==-1) nextDir={x:1,y:0}; if(d==='UP'&&dir.y!==1) nextDir={x:0,y:-1}; if(d==='DOWN'&&dir.y!==-1) nextDir={x:0,y:1}; }));

  // buttons
  startBtn.addEventListener('click', ()=>{ start(); });
  restartBtn.addEventListener('click', ()=>{ restart(); });
  pauseBtn.addEventListener('click', ()=>{ pauseToggle(); });
  dedicBtn.addEventListener('click', ()=>{ const text = `Dédicace à Nolann — mon score: ${score} pts !`; navigator.clipboard.writeText(text).then(()=>showToast('Dédicace copiée !')); });

  // SMS / copy
  smsBtn.addEventListener('click', ()=>{ const text = encodeURIComponent(`Dédicace à Nolann — j'ai fait ${score} pts !`); // try sms: link
    const smsLink = `sms:?body=${text}`; window.location.href = smsLink; });
  copyBtn.addEventListener('click', ()=>{ const text = `Dédicace à Nolann — j'ai fait ${score} pts !`; navigator.clipboard.writeText(text).then(()=>showToast('Texte copié dans le presse-papiers')); });

  // menu apply / open
  applyBtn.addEventListener('click', ()=>{ setSamples(); speed = parseInt(speedRange.value,10); showToast('Paramètres appliqués'); });
  openMenu.addEventListener('click', ()=>{ // simple toggle visibility
    const panel = document.querySelector('.panel'); if(panel.style.display==='none'){ panel.style.display='block'; openMenu.textContent='Fermer le menu'; } else { panel.style.display='none'; openMenu.textContent='Ouvrir le menu'; } });

  clearHS.addEventListener('click', ()=>{ if(confirm('Effacer les high scores ?')){ localStorage.removeItem(hsKey); renderHS(); showToast('High scores effacés'); } });
  exportHS.addEventListener('click', ()=>{ const data = localStorage.getItem(hsKey)||'[]'; const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(data); a.download = 'highscores.json'; a.click(); showToast('Exporté'); });

  // prevent arrow keys scrolling when focused in page (also set earlier keydown preventDefault)
  window.addEventListener('keydown', e=>{ const keys=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' ']; if(keys.includes(e.key)) e.preventDefault(); }, {passive:false});

  // initial
  init();

  // ensure restart button is robust (works even during running)
  restartBtn.addEventListener('click', ()=>{ // quick visual feedback
    restartBtn.disabled = true; setTimeout(()=>restartBtn.disabled=false,300); restart(); });

})();
</script>
</body>
</html>
